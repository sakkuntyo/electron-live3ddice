<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>three.js Cube (D6)</title>

  <!-- three „Å® addons „ÅÆËß£Ê±∫ÂÖà„ÇíÊåáÂÆö -->
  <script type="importmap">
  {
    "imports": {
      "three": "./node_modules/three/build/three.module.js",
      "three/addons/": "./node_modules/three/examples/jsm/"
    }
  }
  </script>

  <style>
    html,body{margin:0;height:100%;background:#0f0;}
    canvas{display:block;width:100%;height:100%}
  </style>
</head>
<body>
  <div id="overlay">
    <button id="rollBtn" class="btn">üé≤ Roll</button>
    <button id="autoBtn" class="btn">Auto-rotate: <span id="autoState">ON</span></button>
    <span>dice
      <input id="dicex" type="range" min="1" max="100" value="1">
      <span id="dicexVal">x 0.1</span>
      <input id="dicey" type="range" min="1" max="100" value="1">
      <span id="diceyVal">y 0.1</span>
      <input id="dicez" type="range" min="1" max="100" value="1">
      <span id="dicezVal">z 0.1</span>
    </span>
    <span>camera
      <input id="camerax" type="range" min="1" max="30" value="1">
      <span id="cameraxVal">x 0.1</span>
      <input id="cameray" type="range" min="1" max="30" value="1">
      <span id="camerayVal">y 0.1</span>
      <!--
      <input id="cameraz" type="range" min="1" max="30" value="1">
      <span id="camerazVal">z 0.1</span>
      -->
    </span>


  </div>

  <script type="module">
    import * as THREE from './node_modules/three/build/three.module.js';
    import { OrbitControls } from './node_modules/three/examples/jsm/controls/OrbitControls.js';

    // ===== Âü∫Êú¨„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó =====
    const scene = new THREE.Scene();

    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
    //camera.position.set(3.5, 2.2, 3.5);
    camera.position.set(0, 0, 0);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // „É©„Ç§„Éà
    scene.add(new THREE.AmbientLight(0xffffff, 0.55));
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(5, 8, 3);
    scene.add(dir);

    // ===== „Çµ„Ç§„Ç≥„É≠„ÅÆ„Éû„ÉÜ„É™„Ç¢„É´Ôºà1„Äú6„ÅÆÊï∞Â≠ó„ÇíCanvas„ÅßÊèèÁîªÔºâ =====
    function faceTexture(n) {
      const c = document.createElement('canvas');
      c.width = c.height = 256;
      const g = c.getContext('2d');
      // Èªí„Éô„Éº„Çπ + „ÅÜ„Å£„Åô„ÇâÂÜÖÂÅ¥„Ç∞„É≠„Éº
      const grd = g.createRadialGradient(128,128,10,128,128,140);
      grd.addColorStop(0, '#121212');
      grd.addColorStop(1, '#000000');
      g.fillStyle = grd;
      g.fillRect(0,0,256,256);

      g.fillStyle = '#e5e5e5';
      g.font = 'bold 160px system-ui, -apple-system, "Segoe UI", Roboto';
      g.textAlign = 'center';
      g.textBaseline = 'middle';
      g.fillText(String(n), 128, 140);

      const tex = new THREE.CanvasTexture(c);
      tex.anisotropy = renderer.capabilities.getMaxAnisotropy?.() ?? 1;
      tex.colorSpace = THREE.SRGBColorSpace;
      return tex;
    }

    // BoxGeometry „ÅÆÈù¢È†ÜÔºàthreeÊ®ôÊ∫ñÔºâ„ÅØÔºö
    // 0: RIGHT, 1: LEFT, 2: TOP, 3: BOTTOM, 4: FRONT, 5: BACK
    // Êï∞Â≠ó„ÅÆÂâ≤„ÇäÂΩì„Å¶„ÅØ„ÅäÂ•Ω„Åø„Åß„ÄÇÔºà„Åì„Åì„Åß„ÅØ FRONT=2, BACK=5 „Å™„Å©„Å®„Åó„Å¶„ÅÑ„Åæ„ÅôÔºâ
    const materials = [
      new THREE.MeshStandardMaterial({ map: faceTexture(3) }), // RIGHT
      new THREE.MeshStandardMaterial({ map: faceTexture(4) }), // LEFT
      new THREE.MeshStandardMaterial({ map: faceTexture(1) }), // TOP
      new THREE.MeshStandardMaterial({ map: faceTexture(6) }), // BOTTOM
      new THREE.MeshStandardMaterial({ map: faceTexture(2) }), // FRONT
      new THREE.MeshStandardMaterial({ map: faceTexture(5) })  // BACK
    ];

    const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), materials);
    scene.add(cube);

    // „ÅÜ„Å£„Åô„Çâ„Ç®„ÉÉ„Ç∏
    const edges = new THREE.LineSegments(
      new THREE.EdgesGeometry(cube.geometry),
      new THREE.LineBasicMaterial({ color:0x333333 })
    );
    cube.add(edges);

    // ===== Êìç‰ΩúÁ≥ªÔºà‰ªªÊÑèÔºâ =====
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.07;
    controls.enablePan = false;
    controls.minDistance = 2.2;
    controls.maxDistance = 8;

    // ===== Auto Rotate =====
    let autoRotate = true;
    const autoState = document.getElementById('autoState');
    document.getElementById('autoBtn').addEventListener('click', () => {
      autoRotate = !autoRotate;
      autoState.textContent = autoRotate ? 'ON' : 'OFF';
    });

    // ===== RollÔºà90¬∞Âçò‰Ωç„Åß„Å¥„Å£„Åü„ÇäÊ≠¢„Åæ„ÇãÔºâ =====
    function randInt(min, max) { return (min + Math.floor(Math.random() * (max - min + 1))); }

function roll() {
  const q = Math.PI / 2;      // 90¬∞
  const spinsX = randInt(0, 4); // 0~4ÂõûËª¢
  const spinsY = randInt(0, 4);
  const endXIdx = randInt(0, 3); // 0,1,2,3 ‚Üí 0,90,180,270¬∞
  const endYIdx = randInt(0, 3);

  // ‰ªä„ÅÆËßíÂ∫¶
  const startX = cube.rotation.x;
  const startY = cube.rotation.y;

  // „ÅÑ„Åæ„ÅÆ„Äå90¬∞„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Äç
  const curXIdx = Math.round(startX / q);
  const curYIdx = Math.round(startY / q);

  // ÁõÆÊ®ô„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å®„ÅÆÂ∑ÆÔºà0..3„Å´Ê≠£Ë¶èÂåñÔºâ+ ÂõûËª¢Êï∞*4Ôºà=2œÄÔºâ
  const dQuarterX = ((endXIdx - curXIdx) % 4 + 4) % 4;
  const dQuarterY = ((endYIdx - curYIdx) % 4 + 4) % 4;

  const deltaX = dQuarterX * q + spinsX * 2 * Math.PI;
  const deltaY = dQuarterY * q + spinsY * 2 * Math.PI;

  const endX = startX + deltaX;
  const endY = startY + deltaY;

  const duration = 1600; // ms
  const t0 = performance.now();
  const wasAuto = autoRotate;
  autoRotate = false; // Ëá™ÂãïÂõûËª¢„Å®Á´∂Âêà„Åï„Åõ„Å™„ÅÑ

  const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

  function step(now) {
    const t = Math.min(1, (now - t0) / duration);
    const k = easeOutCubic(t);
//    cube.rotation.x = startX + deltaX * k;
//    cube.rotation.y = startY + deltaY * k;
//alert((0 + Math.floor(Math.random() * (2 - 0 + 1))))

    if (t < 1) {
      requestAnimationFrame(step);
    } else {
      setTimeout(() => {
        autoRotate = wasAuto;
      },5000)
    }
  }
  requestAnimationFrame(step);
}

    document.getElementById('rollBtn').addEventListener('click', roll);

    // ===== „É´„Éº„Éó =====
    function tick() {
      if (autoRotate) {
        cube.rotation.x += 0.005;
        cube.rotation.y += 0.005;
        cube.rotation.z += 0.005;
      }
      controls.update();
      renderer.render(scene, camera);
      requestAnimationFrame(tick);
    }
    tick();

    // ===== „É™„Çµ„Ç§„Ç∫ÂØæÂøú =====
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    //input
    dicex.addEventListener("input", e => {
      dicexVal.textContent = `x ${e.target.value / 10}`;
      cube.rotation.x = e.target.value / 10
    });
    dicey.addEventListener("input", e => {
      diceyVal.textContent = `y ${e.target.value / 10}`;
      cube.rotation.y = e.target.value / 10
    });
    dicez.addEventListener("input", e => {
      dicezVal.textContent = `z ${e.target.value / 10}`;
      cube.rotation.z = e.target.value / 10
    });
    camerax.addEventListener("input", e => {
      controls.enableDamping = false;               // ÁµåË∑Ø‰æùÂ≠ò„ÇíÁÑ°„Åè„Åô
      cameraxVal.textContent = `x ${e.target.value / 10}`;
      camera.position.x = e.target.value / 10
      controls?.update();   
    });
    cameray.addEventListener("input", e => {
      controls.enableDamping = false;               // ÁµåË∑Ø‰æùÂ≠ò„ÇíÁÑ°„Åè„Åô
      camerayVal.textContent = `y ${e.target.value / 10}`;
      camera.position.y = e.target.value / 10
      controls?.update();   
    });
/* „Å™„Åè„Å¶„ÅÑ„ÅÑ„Åã„ÇÇ
    cameraz.addEventListener("input", e => {
      controls.enableDamping = false;               // ÁµåË∑Ø‰æùÂ≠ò„ÇíÁÑ°„Åè„Åô
      camerazVal.textContent = `z ${e.target.value / 10}`;
      camera.position.z = e.target.value / 10
      controls?.update();   
    });
*/
  </script>
</body>
</html>
